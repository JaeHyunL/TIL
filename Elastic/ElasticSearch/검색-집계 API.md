# 검색 API

생성한 인덱스의 문서를 검색해보자. 앞서 검색과 관련된 여러 API를 살펴보고 엘라스틱 서치의 검색 API에 어떤것이 있는지 아라보자.

엘라스틱서치 검색 API의 사용 방식은 다음과 같이 크게 두 가지로 나뉜다.

> 1. HTTP URI 형태의 파라미터를 URI에 추가해 검색하는 방법

1. Restful API 방식인 QueryDSL을 사용해 요청 본문(Request Body)에 질의 내용을 추가해 검색하는 방법

> 

Request Body 방식은 URI방식보다 제약사항이 적기 때문에 현업에서는 request Reqeust Body 방식을 선호함

간단한 표현식이라면 두가지를 섞어 사용해도 상관 없음.

get /movie/_doc/_search?q=prdtYear:2017&pretty=true

QueryDSL을 사용하면 가독성이 높고, JSON 형식으로 다양한 표현이 가능해진다. Query의 조건을 여러 개 만들거나, 통계를 위한 집계(Aggregation) 쿼리 등 복잡한 쿼리를 작성하려면 QueryDSL을 사용하는 것이 좋다. URI로 여러 단계의 구조를 가지는 중첩된 형태 표현하는것은 불가능하기 때문이다.

먼저 살펴본 방식은 URI방식의 ㄱ머색 질의는 문서 ID인 _id값을 사용해 문서를 조회하는 방식이다 결국 URL에 파라미터를 붙여 조회하는식이다.

```json
GET /movie/_doc_/idIndex?pretty=true
POST /movie/_search?q=장편
```

JSON 포맷 헤더에는 쿼리가 실행된 총 시간(time_out)과 결과를 보여준다. _shards에서는 성공적으로 반환한 샤드의 수와 실패한 샤드의 수를 알 수 있다. hits에서는 일치하는 문서의 수와 함께 점수(_score)가 가장 높은 상위 10개의 문서를 보여준다. 검색에 실패한 샤드의 수는 검색시 설정된 time_out에 따라 결정된다. time_out 시간이 초과되면 그때까지 검색된 내용까지만 검색 결과로 반환한다. 따라서 실패한 샤드의 수가 지나치게 많다면 time_out 수를 적절히 조정해야 한다.

```json
POST /movie/_search
{
  "query": {
    "term": { "typeNM": "장편" }
  }
}
```

### 집계 API

과거에는 통계 작업을 위해 루씬이 제공하는 패싯(Facets) 기능을 많이 활용했다. 하지만 패싯 기능은 기본적으로 디스크 기반으로 동작했고, 분상환경에는 최적화되지 않았기 때문에 대용량 데이터의 통계 작업에는 적합하지 않았다. 이로 인해 많은 장애가 발생했기 때문이다.

엘라스틱서치에서는 5.0 이후에 패싯 방식의 통계 기능을 과감히 제거하고 독자적인(Aggregation) API를 내놓았다. 집계 API는 기본적으로 메모리 기반으로 동작하기 때문에 대용량의 데이터 통계작업이 가능해졌다.

이후에 좀 더 자세히 설명하겟지만 엘라스틱서치는 집계 API를 통해 기존의 패싯 API로는 하기 어려운 작업을 처리하는 것이 가능해졌다. 쿼리에 사용되는 집계에 따라 수치를 계산하고 동적으로 카운팅하거나 히스토그램 같은 작업 등도 할 수 있게 바뀐 것이다. 엘라스틱서치의 집계 API는 각종 통계 데이터를 실시간으로 제공할 수 있는 강력한 기능이 있다.

> 루씬의 패싯 API 패싯은 같은 항목의 총 개수를 표시하는 기능으로 특정 용어를 필터로 카테고리화해 총개수를 취합해 데이터를 정렬해서 제공한다. 패싯 API로 인기 게시물이나 카테고리별 시간당 총 페이지 뷰 등을 반환받을 수 있었지만 이를 시간순으로는 정렬할 수 없다는 큰 단점이 있다. 과거에는 엘라스틱서치도 루씬의 패싯 API를 기반으로 통계를 제공했지만 혀재는 집계 API로 대체된 상태다.

### 데이터 집계

movie 인덱스의 문서를 장르별로 집계해보자. _search API를 사용해 집계 쿼리를 만들고 terms 키워드를 이용해 genreAlt라는 필드의 데이터를 그룹화 한다.

```json
POST /movie/_search?size=0
{
	"aggs": {
		"genre": {
			"terms": {
				"field": "genreAlt"
				}
			}
		}
	}
}
```

### 데이터 집계 타입

집계 기능은 현재 4가지 API로 제공된다. 집계 기능은 서로 조합해 사용할 수 있으며 이를 조합해서 매우 강력한 기능을 제공할 수 있다.

> 버킷 집계: 집계 중 가장 많이 사용한다. 문서의 필드를 기준으로 버킷을 집계한다. 메트릭 집계: 문서에 추출된 값을 가지고 Sum, Max, Min, Avg를 계산한다. 매트릭스 집계: 행렬을 합하거나 곱한다. 파이프라인 집계: 버킷에 도출된 결과 문서를 다른 필드 값을 재분류한다. 즉, 다른 집계에 의해 생성된 출력 결과를 다시 한번 집계한다. 집계가 패싯보다 강력한 이유가 여기에있다.